<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Admin</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
</head>
<body>
  <div class="container">
    <header>
      <h1>Portfolio Admin</h1>
      <p>Manage portfolio projects</p>
    </header>

    <!-- Existing Projects -->
    <section class="projects-list-section">
      <h2>Existing Projects</h2>
      <div id="projectsList">Loading...</div>
    </section>

    <!-- Project Form -->
    <section class="form-wrapper">
      <h2 id="formTitle">New Project</h2>
      <form id="projectForm">
      <!-- Basic Info -->
      <section class="form-section">
        <h2>Basic Information</h2>
        
        <div class="form-group">
          <label for="title">Title *</label>
          <input type="text" id="title" name="title" required>
        </div>

        <div class="form-group">
          <label for="description">Description (one sentence) *</label>
          <input type="text" id="description" name="description" required 
                 placeholder="One-sentence declaration of what this solves and why it matters">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="category">Category *</label>
            <input type="text" id="category" name="category" required 
                   list="categoryList" placeholder="e.g. Python, CAD, Machine Learning">
            <datalist id="categoryList"></datalist>
            <small style="color: #666; font-size: 0.85em;">Type to add new or select existing</small>
          </div>

          <div class="form-group">
            <label for="date">Date *</label>
            <input type="date" id="date" name="date" required>
          </div>
        </div>

        <div class="form-group">
          <label for="tools">Tools (comma-separated)</label>
          <input type="text" id="tools" name="tools" 
                 placeholder="Python, NumPy, Matplotlib">
        </div>
      </section>

      <!-- Content -->
      <section class="form-section">
        <h2>Content</h2>
        
        <div class="form-group">
          <label for="overview">Overview *</label>
          <textarea id="overview" name="overview" rows="4" required
                    placeholder="What was built. Why it matters. Context (coursework, research, self-driven)."></textarea>
        </div>

        <div class="form-group">
          <label for="takeaways">Key Takeaways (one per line) *</label>
          <textarea id="takeaways" name="takeaways" rows="4" required
                    placeholder="First major outcome or engineering insight&#10;Second key result or technical decision made&#10;Third conclusion or learned constraint"></textarea>
        </div>
      </section>

      <!-- Visuals -->
      <section class="form-section">
        <h2>Key Visuals</h2>
        <p class="note">First image becomes hero.png. Drag to reorder.</p>
        
        <div id="visualsList"></div>
        
        <button type="button" id="addVisual" class="btn-secondary">+ Add Visual</button>
      </section>

      <!-- Actions -->
      <div class="form-actions">
        <button type="button" id="cancelEdit" class="btn-secondary" style="display: none;">Cancel</button>
        <button type="submit" class="btn-primary" id="submitBtn">Generate Project</button>
      </div>
    </form>
    </section>

    <div id="result" class="result" style="display: none;"></div>
  </div>

  <script>
    let visualIndex = 0;
    let editMode = false;
    let editingSlug = null;

    // Set today as default date
    document.getElementById('date').valueAsDate = new Date();

    // Load projects list
    loadProjectsList();

    async function loadProjectsList() {
      try {
        const response = await fetch('/projects');
        const result = await response.json();
        
        if (result.success) {
          // Populate category suggestions
          const categories = new Set();
          result.projects.forEach(project => {
            if (project.category) categories.add(project.category);
          });
          const categoryList = document.getElementById('categoryList');
          categoryList.innerHTML = '';
          Array.from(categories).sort().forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            categoryList.appendChild(option);
          });
          
          const listDiv = document.getElementById('projectsList');
          if (result.projects.length === 0) {
            listDiv.innerHTML = '<p class="no-projects">No projects yet</p>';
            return;
          }
          
          let html = '<table class="projects-table"><thead><tr><th>Title</th><th>Category</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
          result.projects.forEach(project => {
            html += `<tr>
              <td><strong>${project.title}</strong></td>
              <td>${project.category}</td>
              <td>${project.date}</td>
              <td class="actions">
                <button onclick="editProject('${project.slug}')" class="btn-edit">Edit</button>
                <button onclick="deleteProject('${project.slug}')" class="btn-delete">Delete</button>
              </td>
            </tr>`;
          });
          html += '</tbody></table>';
          listDiv.innerHTML = html;
        }
      } catch (error) {
        document.getElementById('projectsList').innerHTML = '<p class="error">Failed to load projects</p>';
      }
    }

    window.editProject = async function(slug) {
      try {
        const response = await fetch(`/project/${slug}`);
        const result = await response.json();
        
        if (result.success) {
          const project = result.project;
          
          // Switch to edit mode
          editMode = true;
          editingSlug = slug;
          document.getElementById('formTitle').textContent = `Edit Project: ${project.title}`;
          document.getElementById('submitBtn').textContent = 'Update Project';
          document.getElementById('cancelEdit').style.display = 'inline-block';
          
          // Populate form
          document.getElementById('title').value = project.title;
          document.getElementById('description').value = project.description;
          document.getElementById('category').value = project.category;
          document.getElementById('date').value = project.date;
          document.getElementById('tools').value = project.tools.join(', ');
          document.getElementById('overview').value = project.overview;
          document.getElementById('takeaways').value = project.takeaways.join('\n');
          
          // Clear and populate visuals
          document.getElementById('visualsList').innerHTML = '';
          visualIndex = 0;
          
          project.visuals.forEach((visual, idx) => {
            const visualsList = document.getElementById('visualsList');
            const visualItem = document.createElement('div');
            visualItem.className = 'visual-item';
            visualItem.dataset.index = visualIndex;
            visualItem.innerHTML = `
              <div class="visual-header">
                <span class="visual-number">${visualIndex === 0 ? 'Hero Image' : `Visual ${visualIndex}`}</span>
                <span class="existing-image">Current: ${visual.filename}</span>
                <button type="button" class="btn-remove" onclick="removeVisual(${visualIndex})">Remove</button>
              </div>
              <div class="visual-content">
                <div class="form-group">
                  <label>Image (leave empty to keep existing)</label>
                  <input type="file" name="image_${visualIndex}" accept="image/*">
                </div>
                <div class="form-group">
                  <label>Role *</label>
                  <select name="role_${visualIndex}" required>
                    <option value="">Select...</option>
                    <option value="Result" ${visual.role === 'Result' ? 'selected' : ''}>Result</option>
                    <option value="Design" ${visual.role === 'Design' ? 'selected' : ''}>Design</option>
                    <option value="Analysis" ${visual.role === 'Analysis' ? 'selected' : ''}>Analysis</option>
                    <option value="Process" ${visual.role === 'Process' ? 'selected' : ''}>Process</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Caption *</label>
                  <input type="text" name="caption_${visualIndex}" required value="${visual.caption}">
                </div>
              </div>
            `;
            visualsList.appendChild(visualItem);
            visualIndex++;
          });
          
          // Scroll to form
          document.querySelector('.form-wrapper').scrollIntoView({ behavior: 'smooth' });
        }
      } catch (error) {
        alert(`Failed to load project: ${error.message}`);
      }
    };

    window.deleteProject = async function(slug) {
      if (!confirm(`Are you sure you want to delete this project?\n\nThis will permanently delete:\n- _projects/${slug}.md\n- assets/images/projects/${slug}/\n\nThis cannot be undone.`)) {
        return;
      }
      
      try {
        const response = await fetch(`/project/${slug}`, { method: 'DELETE' });
        const result = await response.json();
        
        if (result.success) {
          showResult('success', result.message);
          loadProjectsList();
        } else {
          showResult('error', result.error);
        }
      } catch (error) {
        showResult('error', `Failed to delete: ${error.message}`);
      }
    };

    document.getElementById('cancelEdit').addEventListener('click', () => {
      cancelEdit();
    });

    function cancelEdit() {
      editMode = false;
      editingSlug = null;
      document.getElementById('formTitle').textContent = 'New Project';
      document.getElementById('submitBtn').textContent = 'Generate Project';
      document.getElementById('cancelEdit').style.display = 'none';
      document.getElementById('projectForm').reset();
      document.getElementById('visualsList').innerHTML = '';
      visualIndex = 0;
      document.getElementById('date').valueAsDate = new Date();
    }

    // Add visual
    document.getElementById('addVisual').addEventListener('click', () => {
      const visualsList = document.getElementById('visualsList');
      const visualItem = document.createElement('div');
      visualItem.className = 'visual-item';
      visualItem.dataset.index = visualIndex;
      visualItem.innerHTML = `
        <div class="visual-header">
          <span class="visual-number">${visualIndex === 0 ? 'Hero Image' : `Visual ${visualIndex}`}</span>
          <button type="button" class="btn-remove" onclick="removeVisual(${visualIndex})">Remove</button>
        </div>
        <div class="visual-content">
          <div class="form-group">
            <label>Image *</label>
            <input type="file" name="image_${visualIndex}" accept="image/*" required>
          </div>
          <div class="form-group">
            <label>Role *</label>
            <select name="role_${visualIndex}" required>
              <option value="">Select...</option>
              <option value="Result">Result</option>
              <option value="Design">Design</option>
              <option value="Analysis">Analysis</option>
              <option value="Process">Process</option>
            </select>
          </div>
          <div class="form-group">
            <label>Caption *</label>
            <input type="text" name="caption_${visualIndex}" required 
                   placeholder="What this image shows">
          </div>
        </div>
      `;
      visualsList.appendChild(visualItem);
      visualIndex++;
    });

    // Remove visual
    window.removeVisual = function(index) {
      const item = document.querySelector(`.visual-item[data-index="${index}"]`);
      if (item) item.remove();
      updateVisualNumbers();
    };

    // Update visual numbers after removal
    function updateVisualNumbers() {
      const items = document.querySelectorAll('.visual-item');
      items.forEach((item, idx) => {
        const numberSpan = item.querySelector('.visual-number');
        numberSpan.textContent = idx === 0 ? 'Hero Image' : `Visual ${idx}`;
      });
    }

    // Form submission
    document.getElementById('projectForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      
      // Add visual count
      const visualCount = document.querySelectorAll('.visual-item').length;
      formData.append('visual_count', visualCount);
      
      // Validate at least one visual
      if (visualCount === 0) {
        showResult('error', 'At least one visual is required (hero image)');
        return;
      }
      
      // Submit
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      const originalText = submitBtn.textContent;
      submitBtn.textContent = editMode ? 'Updating...' : 'Generating...';
      
      try {
        const url = editMode ? `/project/${editingSlug}` : '/generate';
        const method = editMode ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          if (editMode) {
            showResult('success', `✓ ${result.message}${result.slug_changed ? '<br><br>Note: Slug changed, URLs updated.' : ''}<br><br>Run: <code>bundle exec jekyll serve</code> to view.`);
            cancelEdit();
          } else {
            showResult('success', `✓ ${result.message}<br><br>Files created:<br>- ${result.files.markdown}<br>- ${result.files.images.length} image(s)<br><br>Run: <code>bundle exec jekyll serve</code> to view.`);
            e.target.reset();
            document.getElementById('visualsList').innerHTML = '';
            visualIndex = 0;
            document.getElementById('date').valueAsDate = new Date();
          }
          loadProjectsList();
        } else {
          showResult('error', result.error);
        }
      } catch (error) {
        showResult('error', `Request failed: ${error.message}`);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });

    function showResult(type, message) {
      const resultDiv = document.getElementById('result');
      resultDiv.className = `result ${type}`;
      resultDiv.innerHTML = message;
      resultDiv.style.display = 'block';
      window.scrollTo(0, 0);
    }
  </script>
</body>
</html>

